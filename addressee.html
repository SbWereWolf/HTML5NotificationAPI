<!--
  ~ HTML5NotificationAPI
  ~ Copyright © 2020 Volkhin Nikolay
  ~ 21.04.2020, 18:54
  -->

<!DOCTYPE html>
<html lang="ru">
<head>
    <title>стена сообщений</title>
    <meta charset="utf-8">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          rel="stylesheet">
</head>
<body style="margin: 100px auto;">
<div style="
		display: flex;
		justify-content: space-around;">
    <div style="
			display: flex;
			justify-content: space-around;
			flex-direction: column;">
        <p>
            <a href='#' id="dnperm">Request Permission</a>
        </p>
        <h1 style="text-transform: uppercase;">стена сообщений</h1>
        <ol id="comment"></ol>
    </div>
</div>
<script>
    function onReady(fn) {
        if (document.readyState === "complete"
            || document.readyState === "interactive") {
            setTimeout(fn, 100);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    function render(obj) {
        const comment = $("#comment");
        let html = comment.html();
        html +=
            "<li>"
            + `<b>${obj.username}: ${obj.message}</b>`
            + `, ${obj.date}`
            + "</li>";

        comment.html(html);
    }

    function init() {

        const dnperm = document.getElementById("dnperm");
        dnperm.addEventListener("click", function (e) {
            e.preventDefault();
            if (!window.Notification) {
                console.log("Not supported");
            }
            if (window.Notification) {
                Notification.requestPermission().then(function (p) {
                    if (p === "denied") {
                        console.log("You denied to show notification");
                    }
                    if (p === "granted") {
                        console.log("You allowed to show notification");
                    }
                });
            }
        });

        const config = {
            apiKey: "AIzaSyAX3fjxYdQzZAaO8Qc48Cd_xIfx6-Io1aE",
            authDomain: "iufirebaseresearch.firebaseapp.com",
            databaseURL: "https://iufirebaseresearch.firebaseio.com",
            projectId: "iufirebaseresearch",
            storageBucket: "iufirebaseresearch.appspot.com",
            messagingSenderId: "935028061781",
            appId: "1:935028061781:web:cfe39e3e7b252bdc4bc6dc",
            measurementId: "G-1NQFKDR6FB"
        };
        firebase.initializeApp(config);

        const database = firebase.database().ref().child("users");

        database.on("child_added", function (data) {
            if (Notification.permission === "default") {
                console.log("Please allow the notification first");
            }
            if (Notification.permission !== "default") {
                new Notification(
                    data.val().username,
                    {
                        "body": data.val().message,
                        "icon": "images.jpeg",
                    });

                const value = data.val();
                if (typeof value !== typeof undefined && value !== null) {
                    render(value);
                }
            }
        });
    }

    onReady(init);
</script>
<script
        src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-database.js"></script>
</body>
</html>